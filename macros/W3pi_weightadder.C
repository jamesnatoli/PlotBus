#ifndef W3PI_WEIGHTADDER_C
#define W3PI_WEIGHTADDER_C

#include <iostream>
#include <map>
#include "TMath.h"
#include "TLorentzVector.h"
using namespace std;

map< Int_t, Float_t> globalWeights = 
  {
   { 16, 0.9296710337355585},
   { 17, 1.1308222044234897},
   { 18, 1.1288441181091338},
   { 19, 1.0202148411505823},
   { 20, 1.293137522731414},
   { 21, 1.570654631574902},
   { 22, 1.7053439007964257},
   { 23, 1.7619779596269514},
   { 24, 1.8136923672169936},
   { 25, 1.7534620956127371},
   { 26, 1.7712478181290643},
   { 27, 1.6639758021358702},
   { 28, 1.6837263289678555},
   { 31, 1.103087489045673},
   { 32, 1.2611248923475704},
   { 33, 1.1751723866961261},
   { 34, 1.2083402035029922},
   { 35, 1.4501008452275972},
   { 36, 1.6362985590004513},
   { 37, 1.7270576885228826},
   { 38, 1.7448908638857676},
   { 39, 1.7701470271583515},
   { 40, 1.851009413174291},
   { 41, 1.8726358817715556},
   { 42, 1.8162240174161721},
   { 43, 1.764346971874487},
   { 46, 1.2043585979185705},
   { 47, 1.2615154307656915},
   { 48, 1.2751249871509622},
   { 49, 1.3616250580931453},
   { 50, 1.5313842235673785},
   { 51, 1.6275083754194568},
   { 52, 1.7030827888957665},
   { 53, 1.727155987686709},
   { 54, 1.8051923913660979},
   { 55, 1.8205189416587169},
   { 56, 1.8753075577283498},
   { 57, 1.8398699744759064},
   { 58, 1.89969177874949},
   { 61, 1.3517670354116025},
   { 62, 1.3791724878494027},
   { 63, 1.3968211584475345},
   { 64, 1.4579798597591536},
   { 65, 1.6017932601210791},
   { 66, 1.6738918746425433},
   { 67, 1.7498189410843954},
   { 68, 1.753850756177431},
   { 69, 1.787750337269269},
   { 70, 1.767137124477454},
   { 71, 1.7891944487700726},
   { 72, 1.905448087930903},
   { 73, 1.8721888620742413},
   { 76, 1.5079615774166069},
   { 77, 1.5109398825737235},
   { 78, 1.5411159419840164},
   { 79, 1.6232218682651296},
   { 80, 1.7108795068099185},
   { 81, 1.7616575783047148},
   { 82, 1.769602016273095},
   { 83, 1.7810966469576541},
   { 84, 1.7868179169318583},
   { 85, 1.8430878080510833},
   { 86, 1.8882189022148321},
   { 87, 1.7514979579576224},
   { 88, 1.9951912171252177},
   { 91, 1.6491447765880087},
   { 92, 1.6367125007572385},
   { 93, 1.6941331564847193},
   { 94, 1.7588149515947542},
   { 95, 1.7854278079822907},
   { 96, 1.8023285041413257},
   { 97, 1.7673535046012951},
   { 98, 1.8148738240332591},
   { 99, 1.7540226606791227},
   { 100, 1.962734669744903},
   { 101, 1.9528839404602778},
   { 102, 1.8724886597759267},
   { 103, 1.984264007315044},
   { 106, 1.7962299010569438},
   { 107, 1.8175126524728669},
   { 108, 1.8284733444594357},
   { 109, 1.7954033782393055},
   { 110, 1.8327366104331122},
   { 111, 1.896494768134992},
   { 112, 1.868377829770787},
   { 113, 1.9046020837657063},
   { 114, 1.9122213789842764},
   { 115, 1.8940859641115804},
   { 116, 1.9989888713998687},
   { 117, 1.8580849640082373},
   { 118, 2.008768876531225},
   { 121, 1.8961523115440855},
   { 122, 1.8889528943641818},
   { 123, 1.8869636567104207},
   { 124, 1.8774522515432377},
   { 125, 1.88461465018557},
   { 126, 1.8663278227128701},
   { 127, 1.8568924298652967},
   { 128, 1.954975212565327},
   { 129, 1.9223429490327402},
   { 130, 1.8738474097345421},
   { 131, 1.8857858588069636},
   { 132, 2.060155950604863},
   { 133, 1.908681388728315},
   { 136, 1.911353776048267},
   { 137, 1.9308823186875503},
   { 138, 1.835381697854438},
   { 139, 1.8734111155411282},
   { 140, 1.8680879441311433},
   { 141, 1.7762092079405922},
   { 142, 1.9477743263070006},
   { 143, 1.8913288748324104},
   { 144, 1.8135869936688902},
   { 145, 2.0578851354761367},
   { 146, 2.0075195015440355},
   { 147, 1.813312379302478},
   { 148, 2.0822454883677994},
   { 151, 1.9201702413926336},
   { 152, 1.8712376460311086},
   { 153, 1.781989713695139},
   { 154, 1.742326896358031},
   { 155, 1.7822065058506267},
   { 156, 1.8340229776277934},
   { 157, 1.7628777186334277},
   { 158, 2.005142773263732},
   { 159, 1.8962407197317928},
   { 160, 1.9740969374118076},
   { 161, 1.81979834564444},
   { 162, 1.8885096098866436},
   { 163, 2.1555415184819102},
   { 166, 1.7530927056429255},
   { 167, 1.7304342553393062},
   { 168, 1.6926152298721444},
   { 169, 1.6389378272452266},
   { 170, 1.6347133073738103},
   { 171, 1.6662502792228313},
   { 172, 1.6962213195393119},
   { 173, 1.7942683009717337},
   { 174, 1.7579883411120236},
   { 175, 1.8620586765339562},
   { 176, 1.8677559318840895},
   { 177, 1.8321303141947096},
   { 178, 2.026376488516309},
   { 181, 1.3729183543742458},
   { 182, 1.3775170108003976},
   { 183, 1.3779658357870421},
   { 184, 1.3615501614944725},
   { 185, 1.3389896844936524},
   { 186, 1.3930935747623678},
   { 187, 1.4613458982339946},
   { 188, 1.5616980791093675},
   { 189, 1.6719562207110628},
   { 190, 1.819467033456541},
   { 191, 1.78557200829863},
   { 192, 1.892397414680441},
   { 193, 2.1278471223144333},
  };

Float_t GetFromAllWeights(Float_t dxy, Float_t dz, bool norm){

  // Set normalization factor here
  // this is calculated from Nentries / SUM( W_i * B_i)
  Float_t normalization = 1.0/1.0152903093666275; 
  map<Float_t, map<Float_t, Float_t>> Weights;

  // 13 bins in Dxy, 12 in Dz
  // Keys are high-edge values of each bin
  vector<Float_t> dxyKeys{ 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007, 0.008, 0.009, 0.01, 0.011, 0.013, 0.045}; 
  vector<Float_t> dzKeys{ 0.005, 0.01, 0.015, 0.02, 0.025, 0.03, 0.035, 0.04, 0.045, 0.05, 0.06, 0.2}; 

  Float_t xWidth = dxyKeys.size() + 2; // account for overflow
  for (unsigned int y = 1; y <= dzKeys.size(); ++y) 
    for (unsigned int x = 1; x <= dxyKeys.size(); ++x) 
      Weights[ dxyKeys[x-1]][dzKeys[y-1]] = globalWeights[ x + (xWidth*y)];
  
  /* Print, if you want? but probably not...
  for (int y = dzKeys.size() - 1; y >= 0; --y) {
    std::cout << std::endl;
    for (int x = 0; x < dxyKeys.size(); ++x)
      std::cout << setw(10) << Weights[ dxyKeys[x]][dzKeys[y]];
    std::cout << std::endl;
    } */

  Float_t dxybin = dxy;
  if(find(dxyKeys.begin(), dxyKeys.end(), dxybin) == dxyKeys.end()) {
    for(Float_t i : dxyKeys){
      if(dxybin <= i){
        dxybin = i;
        break;
      }
    }
  }
  // If we hit exactly a dxy bin edge, we don't need to assign the binKey actually
  // this puts it in the highest bin if it's outside
  if(dxybin > dxyKeys[dxyKeys.size()-1]) dxybin = dxyKeys[dxyKeys.size()-1];

  Float_t dzbin = dz;
  if(find(dzKeys.begin(), dzKeys.end(), dzbin) == dzKeys.end()) {
    for(Float_t i : dzKeys){
      if(dzbin <= i){
        dzbin = i;
        break;
      }
    }
  }
  // If we hit exactly a dxy bin edge, we don't need to assign the binKey actually
  if(dzbin > dzKeys[dzKeys.size()-1]) dzbin = dzKeys[dzKeys.size()-1];

  // Because we don't want to normalize the first time? -> Yes, the bool is False for the first weight
  if (!norm) normalization = 1.0;

  return Weights[dxybin][dzbin] * normalization;
}

Float_t IPweight(Float_t dxy1, Float_t dz1){
  return GetFromAllWeights(dxy1, dz1, true); // "true" to have weight not affect normalization at all
}

Float_t IPweight(Float_t dxy1, Float_t dz1, Float_t dxy2, Float_t dz2){
  Float_t weight = 1.0;
  weight = weight * GetFromAllWeights(dxy1, dz1, true); // "true" to have weight not affect normalization at all
  weight = weight * GetFromAllWeights(dxy2, dz2, true);
  return weight;
}

Float_t IPweight(Float_t dxy1, Float_t dz1, Float_t dxy2, Float_t dz2, Float_t dxy3, Float_t dz3){
  Float_t weight = 1.0;
  weight = weight * GetFromAllWeights(dxy1, dz1, true); // "true" to have weight not affect normalization at all
  weight = weight * GetFromAllWeights(dxy2, dz2, true);
  weight = weight * GetFromAllWeights(dxy3, dz3, true);
  return weight;
}

void W3pi_weightadder(){
  std::cout << ">>> Opening W3pi_weightadder.C ... " << endl;
  gROOT->ProcessLine( ".L macros/W3pi_weightadder.C");
}

#endif
